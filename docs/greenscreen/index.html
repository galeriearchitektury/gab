<h3>Background</h3>
<p>
    The ImageCapture Web API allows web developers to capture images from camera
    in the form of a Blob with <code>takePhoto()</code> or as a ImageBitmap with
    <code>grabFrame()</code>.
</p>

<div id="results">
    <div>
        <video
            autoplay
            width="0"
            height="0"
            id="video"
            style="display: none"
        ></video>
    </div>
    <div>
        <button id="getUserMediaButton">Get User Media</button>
        <button id="grabFrameButton" disabled>Grab Frame</button>
    </div>
    <div>
        <canvas id="output-canvas" width="640" height="480"></canvas>
    </div>
    <img src="" width="640" height="480" />
</div>

<script>
    var imageCapture;

    function onGetUserMediaButtonClick() {
        navigator.mediaDevices
            .getUserMedia({ video: true })
            .then((mediaStream) => {
                document.querySelector('video').srcObject = mediaStream;

                const track = mediaStream.getVideoTracks()[0];
                imageCapture = new ImageCapture(track);
            })
            .catch((error) => ChromeSamples.log(error));
    }

    function onGrabFrameButtonClick() {
        var myImageData = c1.toDataURL();
        console.log(myImageData);
        document.querySelector('img').src = myImageData;
    }

    function onTakePhotoButtonClick() {
        imageCapture
            .takePhoto()
            .then((blob) => createImageBitmap(blob))
            .then((imageBitmap) => {
                const canvas = document.querySelector('#takePhotoCanvas');
                drawCanvas(canvas, imageBitmap);
            })
            .catch((error) => ChromeSamples.log(error));
    }

    function drawCanvas(canvas, img) {
        canvas.width = getComputedStyle(canvas).width.split('px')[0];
        canvas.height = getComputedStyle(canvas).height.split('px')[0];
        let ratio = Math.min(
            canvas.width / img.width,
            canvas.height / img.height
        );
        let x = (canvas.width - img.width * ratio) / 2;
        let y = (canvas.height - img.height * ratio) / 2;
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        canvas
            .getContext('2d')
            .drawImage(
                img,
                0,
                0,
                img.width,
                img.height,
                x,
                y,
                img.width * ratio,
                img.height * ratio
            );
    }

    document
        .querySelector('#getUserMediaButton')
        .addEventListener('click', onGetUserMediaButtonClick);
    document
        .querySelector('#grabFrameButton')
        .addEventListener('click', onGrabFrameButtonClick);

    document.addEventListener('DOMContentLoaded', () => {
        init();
        video.addEventListener('play', function () {
            document.querySelector('#grabFrameButton').disabled = false;
        });
        video.addEventListener('play', computeFrame);
    });

    let video = document.querySelector('video');

    let video2, c1, ctx1, c_tmp, ctx_tmp;

    c1 = document.getElementById('output-canvas');
    ctx1 = c1.getContext('2d');

    function computeFrame() {
        if (video.paused || video.ended) {
            return;
        }
        ctx_tmp.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        let frame = ctx_tmp.getImageData(
            0,
            0,
            video.videoWidth,
            video.videoHeight
        );

        ctx_tmp.drawImage(video2, 0, 0, video2.videoWidth, video2.videoHeight);
        let frame2 = ctx_tmp.getImageData(
            0,
            0,
            video2.videoWidth,
            video2.videoHeight
        );

        for (let i = 0; i < frame.data.length / 4; i++) {
            let r = frame.data[i * 4 + 0];
            let g = frame.data[i * 4 + 1];
            let b = frame.data[i * 4 + 2];

            if (r > 70 && r < 160 && g > 95 && g < 220 && b > 25 && b < 150) {
                frame.data[i * 4 + 0] = frame2.data[i * 4 + 0];
                frame.data[i * 4 + 1] = frame2.data[i * 4 + 1];
                frame.data[i * 4 + 2] = frame2.data[i * 4 + 2];
            }
        }
        ctx1.putImageData(frame, 0, 0);
        setTimeout(computeFrame, 0);
    }

    function init() {
        video = document.getElementById('video');

        video2 = document.createElement('video');
        video2.src = '../kombucha-compressed.mp4';
        video2.muted = true;
        video2.autoplay = true;

        c1 = document.getElementById('output-canvas');
        ctx1 = c1.getContext('2d');

        c_tmp = document.createElement('canvas');
        c_tmp.setAttribute('width', 640);
        c_tmp.setAttribute('height', 480);
        ctx_tmp = c_tmp.getContext('2d');

        video.addEventListener('play', computeFrame);
    }
</script>
